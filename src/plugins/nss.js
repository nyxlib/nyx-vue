/*--------------------------------------------------------------------------------------------------------------------*/
/* VARIABLES                                                                                                          */
/*--------------------------------------------------------------------------------------------------------------------*/

let endpoint = '';

const streams = new Map();

/*--------------------------------------------------------------------------------------------------------------------*/
/* FUNCTIONS                                                                                                          */
/*--------------------------------------------------------------------------------------------------------------------*/

const _endpoint_func = () => endpoint;

/*--------------------------------------------------------------------------------------------------------------------*/

const _update_func = (_endpoint) => {

    endpoint = (_endpoint || '').trim();
};

/*--------------------------------------------------------------------------------------------------------------------*/

const _register_func = (stream, callback) => {

    if(!stream || !endpoint || typeof callback !== 'function')
    {
        return;
    }

    /*----------------------------------------------------------------------------------------------------------------*/

    let entry = streams.get(stream);

    if(!entry)
    {
        /*------------------------------------------------------------------------------------------------------------*/

        entry = {
            socket: null,
            callbacks: new Set(),
        };

        /*------------------------------------------------------------------------------------------------------------*/

        entry.socket = new WebSocket(new URL(`/streams/${stream}`, endpoint));

        entry.socket.addEventListener('message', (e) => {

            for(const callback of entry.callbacks)
            {
                try
                {
                    callback(e.data)
                }
                catch(_)
                {
                    /* IGNORE */
                }
            }
        });

        entry.socket.addEventListener('close', () => {

            streams.delete(stream);
        });

        /*------------------------------------------------------------------------------------------------------------*/

        streams.set(stream, entry);

        /*------------------------------------------------------------------------------------------------------------*/
    }

    entry.callbacks.add(callback);

    /*----------------------------------------------------------------------------------------------------------------*/
};

/*--------------------------------------------------------------------------------------------------------------------*/

const _unregister_func = (stream, callback) => {

    if(!stream || !endpoint || typeof(callback) !== 'function')
    {
        return;
    }

    /*----------------------------------------------------------------------------------------------------------------*/

    const entry = streams.get(stream);

    if(entry)
    {
        /*------------------------------------------------------------------------------------------------------------*/

        entry.callbacks.delete(callback);

        /*------------------------------------------------------------------------------------------------------------*/

        if(entry.callbacks.size === 0)
        {
            streams.delete(stream);

            entry.socket.close();
        }

        /*------------------------------------------------------------------------------------------------------------*/
    }

    /*----------------------------------------------------------------------------------------------------------------*/
};

/*--------------------------------------------------------------------------------------------------------------------*/

export default {

    install(app)
    {
        app.provide('nss', {
            endpoint  : _endpoint_func  ,
            update    : _update_func    ,
            register  : _register_func  ,
            unregister: _unregister_func,
        });
    }
};

/*--------------------------------------------------------------------------------------------------------------------*/
