<script setup>
/*--------------------------------------------------------------------------------------------------------------------*/

import {ref, watch, nextTick, onMounted, onUnmounted} from 'vue';

import {createPopper} from '@popperjs/core';

import flatpickr from 'flatpickr';

/*--------------------------------------------------------------------------------------------------------------------*/
/* VARIABLES                                                                                                          */
/*--------------------------------------------------------------------------------------------------------------------*/

const props = defineProps({
    inline: {
        type: Boolean,
        default: true,
    },
    enableTime: {
        type: Boolean,
        default: true,
    },
    modelValue: {
        type: [Date, null],
        default: null,
    },
});

/*--------------------------------------------------------------------------------------------------------------------*/

const emit = defineEmits([
    'update:modelValue',
    'date-change',
]);

/*--------------------------------------------------------------------------------------------------------------------*/

const inputRef = ref(null);

/*--------------------------------------------------------------------------------------------------------------------*/

let flatpickrInstance = null;

let popperInstance = null;

/*--------------------------------------------------------------------------------------------------------------------*/
/* FUNCTIONS                                                                                                          */
/*--------------------------------------------------------------------------------------------------------------------*/

const onDocClick = (e) => {

    if(flatpickrInstance && !props.inline)
    {
        const insideCalendar = flatpickrInstance.calendarContainer?.contains(e.target) || inputRef.value?.contains(e.target);

        if(!insideCalendar)
        {
            flatpickrInstance.close();
        }
    }
};

/*--------------------------------------------------------------------------------------------------------------------*/
/* INITIALIZATION                                                                                                     */
/*--------------------------------------------------------------------------------------------------------------------*/

onMounted(() => {

    nextTick().then(() => {

        /*------------------------------------------------------------------------------------------------------------*/

        const defaultDate = props.modelValue ?? new Date();

        /*------------------------------------------------------------------------------------------------------------*/

        flatpickrInstance = flatpickr(inputRef.value, {

            /*--------------------------------------------------------------------------------------------------------*/

            static: false,
            inline: props.inline,

            /*--------------------------------------------------------------------------------------------------------*/

            time_24hr: true,
            dateFormat: props.enableTime ? 'Y-m-d H:i:S' : 'Y-m-d',
            enableTime: props.enableTime,
            defaultDate: defaultDate,
            minuteIncrement: 1,

            /*--------------------------------------------------------------------------------------------------------*/

            onOpen: () => {

                if(!props.inline)
                {
                    popperInstance = createPopper(inputRef.value, flatpickrInstance.calendarContainer, {
                        placement: 'bottom-start',
                        modifiers: [
                            {name: 'flip', options: {fallbackPlacements: ['top-start', 'right-start', 'left-start']}},
                            {name: 'preventOverflow', options: {boundary: 'viewport'}},
                            {name: 'offset', options: {offset: [0, 6]}},
                        ],
                    });
                }
            },

            /*--------------------------------------------------------------------------------------------------------*/

            onClose: () => {

                popperInstance?.destroy();
            },

            /*--------------------------------------------------------------------------------------------------------*/

            onValueUpdate: () => {

                popperInstance?.update();
            },

            onMonthChange: () => {

                popperInstance?.update();
            },

            onYearChange: () => {

                popperInstance?.update();
            },

            /*--------------------------------------------------------------------------------------------------------*/

            onChange: (dates) => {

                if(dates.length > 0)
                {
                    const date = new Date(dates[0]);

                    emit('update:modelValue', date);

                    emit('date-change', date);
                }
            },

            /*--------------------------------------------------------------------------------------------------------*/
        });

        /*------------------------------------------------------------------------------------------------------------*/

        watch(() => props.modelValue, (value) => {

            if((value instanceof Date) && (flatpickrInstance?.selectedDates?.at(0)?.getTime() !== value.getTime()))
            {
                flatpickrInstance.setDate(value, false);

                popperInstance?.update();
            }
        });

        /*------------------------------------------------------------------------------------------------------------*/

        document.addEventListener('click', onDocClick, true);

        /*------------------------------------------------------------------------------------------------------------*/
    });
});

/*--------------------------------------------------------------------------------------------------------------------*/

onUnmounted(() => {

    /*----------------------------------------------------------------------------------------------------------------*/

    document.removeEventListener('click', onDocClick, true);

    /*----------------------------------------------------------------------------------------------------------------*/

    popperInstance?.destroy();

    /*----------------------------------------------------------------------------------------------------------------*/

    flatpickrInstance?.destroy();

    /*----------------------------------------------------------------------------------------------------------------*/
});

/*--------------------------------------------------------------------------------------------------------------------*/
</script>

<template>

    <!-- *********************************************************************************************************** -->

    <input type="text" :hidden="inline" ref="inputRef" />

    <!-- *********************************************************************************************************** -->

</template>
