<!--suppress JSUnresolvedReference, JSUnusedGlobalSymbols -->
<script setup>
/*--------------------------------------------------------------------------------------------------------------------*/

import {ref, watch, nextTick, onMounted, onUnmounted} from 'vue';

/*--------------------------------------------------------------------------------------------------------------------*/

import flatpickr from 'flatpickr';

/*--------------------------------------------------------------------------------------------------------------------*/
/* VARIABLES                                                                                                          */
/*--------------------------------------------------------------------------------------------------------------------*/

const props = defineProps({
    inline: {
        type: Boolean,
        default: true,
    },
    enableTime: {
        type: Boolean,
        default: true,
    },
    modelValue: {
        type: [Date, null],
        default: null,
    },
});

/*--------------------------------------------------------------------------------------------------------------------*/

const emit = defineEmits(['update:modelValue', 'date-change']);

/*--------------------------------------------------------------------------------------------------------------------*/

const inputRef = ref(null);

/*--------------------------------------------------------------------------------------------------------------------*/

let flatpickrInstance = null;

/*--------------------------------------------------------------------------------------------------------------------*/
/* INITIALIZATION                                                                                                     */
/*--------------------------------------------------------------------------------------------------------------------*/

onMounted(() => {

    nextTick().then(() => {

        /*------------------------------------------------------------------------------------------------------------*/

        const defaultDate = props.modelValue ?? new Date();

        /*------------------------------------------------------------------------------------------------------------*/

        // noinspection JSValidateTypes
        flatpickrInstance = flatpickr(inputRef.value, {
            /*--------------------------------------------------------------------------------------------------------*/

            time_24hr: true,
            inline: props.inline,
            dateFormat: props.enableTime
                                  ? 'Z' : 'Y-m-d',
            enableTime: props.enableTime,
            defaultDate: defaultDate,
            minuteIncrement: 1,

            /*--------------------------------------------------------------------------------------------------------*/

            onChange: (dates) => {

                if(dates.length > 0)
                {
                    const date = new Date(dates[0].getTime());

                    emit('update:modelValue', date);

                    emit('date-change', date);
                }
            },

            /*--------------------------------------------------------------------------------------------------------*/
        });

        /*------------------------------------------------------------------------------------------------------------*/

        watch(() => props.modelValue, (value) => {

            if((value instanceof Date) && (flatpickrInstance?.selectedDates?.at(0)?.getTime() !== value.getTime()))
            {
                flatpickrInstance.setDate(value, false);
            }
        });

        /*------------------------------------------------------------------------------------------------------------*/
    });
});

/*--------------------------------------------------------------------------------------------------------------------*/

onUnmounted(() => {

    if(flatpickrInstance)
    {
        flatpickrInstance.destroy();

        flatpickrInstance = null;
    }
});

/*--------------------------------------------------------------------------------------------------------------------*/
</script>

<template>

    <!-- *********************************************************************************************************** -->

    <input type="text" :hidden="inline" ref="inputRef" />

    <!-- *********************************************************************************************************** -->

</template>
