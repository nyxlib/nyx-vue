<!--suppress JSUnresolvedReference, JSUnusedGlobalSymbols -->
<script setup>
/*--------------------------------------------------------------------------------------------------------------------*/

import {ref, watch, onMounted, onUnmounted} from 'vue';

/*--------------------------------------------------------------------------------------------------------------------*/

import flatpickr from 'flatpickr';

/*--------------------------------------------------------------------------------------------------------------------*/
/* VARIABLES                                                                                                          */
/*--------------------------------------------------------------------------------------------------------------------*/

const props = defineProps({
    inline: {
        type: Boolean,
        default: true,
    },
    enableTime: {
        type: Boolean,
        default: true,
    },
    modelValue: {
        type: [Date, null],
        default: null,
    },
});

/*--------------------------------------------------------------------------------------------------------------------*/

const emit = defineEmits(['update:modelValue', 'date-change']);

/*--------------------------------------------------------------------------------------------------------------------*/

const inputRef = ref(null);

/*--------------------------------------------------------------------------------------------------------------------*/

let flatpickrInstance = null;

/*--------------------------------------------------------------------------------------------------------------------*/
/* INITIALIZATION                                                                                                     */
/*--------------------------------------------------------------------------------------------------------------------*/

onMounted(() => {

    /*----------------------------------------------------------------------------------------------------------------*/

    const defaultDate = props.modelValue ?? new Date();

    /*----------------------------------------------------------------------------------------------------------------*/

    const onChange = (dates) => {

        if(dates.length > 0)
        {
            const date = new Date(dates[0].getTime());

            emit('update:modelValue', date);

            setTimeout(() => {

                emit('date-change', date);

            }, 100);
        }
    };

    /*----------------------------------------------------------------------------------------------------------------*/

    // noinspection JSValidateTypes
    flatpickrInstance = flatpickr(inputRef.value, {
        dateFormat: !props.enableTime ? 'Y-m-d' : 'Z',
        time_24hr: true,
        inline: props.inline,
        enableTime: props.enableTime,
        defaultDate: defaultDate,
        onChange: onChange,
        onClose: onChange,
    });

    /*----------------------------------------------------------------------------------------------------------------*/

    watch(() => props.modelValue, (value) => {

        if(flatpickrInstance.selectedDates?.[0]?.getTime() !== value.getTime() && value instanceof Date)
        {
            flatpickrInstance.setDate(value, false);
        }
    });

    /*----------------------------------------------------------------------------------------------------------------*/
});

/*--------------------------------------------------------------------------------------------------------------------*/

onUnmounted(() => {

    if(flatpickrInstance)
    {
        flatpickrInstance.destroy();

        flatpickrInstance = null;
    }
});

/*--------------------------------------------------------------------------------------------------------------------*/
</script>

<template>

    <!-- *********************************************************************************************************** -->

    <input type="text" :hidden="inline" ref="inputRef" />

    <!-- *********************************************************************************************************** -->

</template>
