/*--------------------------------------------------------------------------------------------------------------------*/

import { inject } from 'vue';

import { createPinia } from 'pinia';

/*--------------------------------------------------------------------------------------------------------------------*/

import indiPlugin from './plugins/indi';
import mqttPlugin from './plugins/mqtt';

import useIndiStore from './stores/indi';

import IndiVariable from './components/IndiVariable.vue';
import IndiDashboard from './components/IndiDashboard.vue';

/*--------------------------------------------------------------------------------------------------------------------*/

const setup = (app) => {

    /*----------------------------------------------------------------------------------------------------------------*/

    app.use(createPinia());

    /*----------------------------------------------------------------------------------------------------------------*/

    app.use(indiPlugin);
    app.use(mqttPlugin);

    /*----------------------------------------------------------------------------------------------------------------*/
};

/*--------------------------------------------------------------------------------------------------------------------*/

const init = () => {

    /*----------------------------------------------------------------------------------------------------------------*/

    const indi = inject('indi');
    const mqtt = inject('mqtt');

    /*----------------------------------------------------------------------------------------------------------------*/

    mqtt.subscribe('indi/json', (json) => {

        try
        {
            indi.processMessage(JSON.parse(json));
        }
        catch(e)
        {
            console.error(`Error parsing message: ${e}`);
        }
    });

    /*----------------------------------------------------------------------------------------------------------------*/
};

/*--------------------------------------------------------------------------------------------------------------------*/

export {
    setup,
    init,
    useIndiStore,
    IndiVariable,
    IndiDashboard,
};

/*--------------------------------------------------------------------------------------------------------------------*/
